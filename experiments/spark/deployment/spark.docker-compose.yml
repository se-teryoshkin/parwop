version: '2.4'
services:

  spark-local:
    container_name: spark-local
    image: parwop-experiments:spark-3.5.1
    build:
      context: .
      dockerfile: Dockerfile
    mem_limit: ${MEMORY_LIMIT}
    cpus: ${CPU_COUNT}
    security_opt:
      - seccomp:unconfined
    network_mode: "host"
    environment:
      MEMORY_LIMIT: ${MEMORY_LIMIT}
      CPU_LIMIT: ${CPU_COUNT}
    volumes:
      - /data/hdd/experiments-parwop/spark/data:/data:ro
      - /mnt/nfs/parwop:/mnt/nfs/parwop:z
    user: root
    command: ["bash", "-c", "while true; do sleep 5; done"]
    entrypoint: []

  spark-master:
    container_name: spark-master
    network_mode: "host"
    image: bitnamilegacy/spark:3.5.1-debian-12-r2
    #ports:
    #  - "7077:7077"
    #  - "8080:8080"
    environment:
      SPARK_MODE: master
      SPARK_RPC_AUTHENTICATION_ENABLED: "no"
      SPARK_RPC_ENCRYPTION_ENABLED: "no"
      SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: "no"
      SPARK_SSL_ENABLED: "no"
      SPARK_USER: spark

  spark-worker:
    container_name: spark-worker
    image: parwop-experiments:spark-3.5.1
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: "host"
    mem_limit: ${MEMORY_LIMIT}
    cpus: ${CPU_COUNT}
    security_opt:
      - seccomp:unconfined
    environment:
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://node6.bdcl:7077
      SPARK_WORKER_MEMORY: ${MEMORY_LIMIT}
      SPARK_WORKER_CORES: ${CPU_COUNT}
      SPARK_WORKER_PORT: 6066
      SPARK_RPC_AUTHENTICATION_ENABLED: "no"
      SPARK_RPC_ENCRYPTION_ENABLED: "no"
      SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: "no"
      SPARK_SSL_ENABLED: "no"
      SPARK_USER: spark
    volumes:
      - /data/hdd/experiments-parwop/spark/data:/data:ro
      - /mnt/nfs/parwop:/mnt/nfs/parwop:z
